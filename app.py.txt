from flask import Flask, request, send_file
from datetime import datetime

app = Flask(__name__)

@app.route("/")
def home():
    return """
    <!DOCTYPE html>
    <html>
    <head>
        <title>Location Tracker</title>
        <script>
            function sendLocation(position) {
                fetch("/log", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify({
                        latitude: position.coords.latitude,
                        longitude: position.coords.longitude,
                        timestamp: new Date().toISOString()
                    })
                }).then(() => {
                    document.getElementById("status").innerText = "üìç Location sent successfully.";
                }).catch(() => {
                    document.getElementById("status").innerText = "‚ùå Failed to send location.";
                });
            }

            function getLocation() {
                if (navigator.geolocation) {
                    navigator.geolocation.getCurrentPosition(sendLocation, function(error) {
                        document.getElementById("status").innerText = "‚ùå Location access denied.";
                    });
                } else {
                    document.getElementById("status").innerText = "‚ö†Ô∏è Geolocation not supported.";
                }
            }

            window.onload = getLocation;
        </script>
    </head>
    <body>
        <h2>üîç Checking your location...</h2>
        <p id="status">Waiting for permission...</p>
    </body>
    </html>
    """

@app.route("/log", methods=["POST"])
def log_location():
    data = request.get_json()
    if data:
        log_entry = f"{datetime.utcnow()} | Lat: {data.get('latitude')} | Lon: {data.get('longitude')} | Time: {data.get('timestamp')}\n"
        with open("shared_text.txt", "a") as f:
            f.write(log_entry)
    return "", 204

@app.route("/view")
def view_locations():
    try:
        return send_file("shared_text.txt", mimetype="text/plain")
    except FileNotFoundError:
        return "No locations logged yet."

if __name__ == "__main__":
    app.run(host="0.0.0.0", port=5000)
